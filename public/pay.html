<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>Paiement test — Carte, COD, Split</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;max-width:980px;margin:24px auto;padding:0 16px}
      h1{font-size:22px;margin:0 0 18px}
      .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0}
      input[type=text]{width:100%;max-width:720px;padding:8px}
      button{padding:10px 14px;border:1px solid #111;border-radius:6px;background:#111;color:#fff;cursor:pointer}
      button:disabled{opacity:.6;cursor:not-allowed}
      .muted{color:#666}
      .ok{background:#e8fff0;border:1px solid #a8e6bf;padding:10px;border-radius:6px}
      .warn{background:#fff5e6;border:1px solid #ffd59c;padding:10px;border-radius:6px}
      #card-element{padding:10px;border:1px solid #ddd;border-radius:6px;max-width:420px}
      pre{background:#f7f7f7;padding:12px;border-radius:6px;white-space:pre-wrap}
    </style>
  </head>
  <body>
    <h1>Paiement test (portion carte / COD / Split)</h1>
    <p class="muted">Carte test Stripe&nbsp;: <b>4242 4242 4242 4242</b> • date future • CVC <b>123</b></p>

    <div class="row">
      <span>Client Secret :</span>
      <input id="secret" type="text" placeholder="pi_xxx_secret_xxx" />
    </div>

    <div class="row">
      <span>Stripe Publishable Key :</span>
      <input id="pk" type="text" placeholder="pk_test_xxx (se remplit via ?pk=...)" />
      <button id="fill-link" type="button">Préremplir via l’URL</button>
    </div>

    <div id="card-element"></div>

    <div class="row" style="margin-top:12px">
  
      <button id="pay-now">Payer maintenant</button>
      <button id="cod-button" style="background:#0a7; border-color:#0a7">2) Paiement à la livraison</button>

    </div>

    <p id="hint" class="warn">Stripe initialisé. Entre le <b>client_secret</b> (ou clique “Créer paiement”) puis clique “Payer maintenant”.</p>

    <h3>Résultat</h3>
    <pre id="out">{ "hint": "Clique d’abord sur 'Créer paiement' (ou remplis ?secret=...&pk=...). Puis 'Payer maintenant'." }</pre>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
      // --- util
      const $ = (sel)=>document.querySelector(sel);
      const out = $("#out");
      const hint = $("#hint");
      const secretInput = $("#secret");
      const pkInput = $("#pk");

      function getParam(name){
        const u = new URL(window.location.href);
        return u.searchParams.get(name);
      }

      // Préremplissage depuis l’URL
      function prefillFromURL(){
        const secret = getParam('secret');
        const pk = getParam('pk');
        if (secret) secretInput.value = secret;
        if (pk) pkInput.value = pk;
      }
      $("#fill-link").onclick = prefillFromURL;
      prefillFromURL();

      // --- Stripe init (à la volée quand pk est connu)
      let stripe, elements, card;
      function ensureStripe(){
        const pk = pkInput.value.trim();
        if (!pk) { hint.textContent = "⚠️ Entre ta clé publishable pk_test_..."; return false; }
        if (!stripe){
          stripe = Stripe(pk);
          elements = stripe.elements();
          card = elements.create('card');
          card.mount('#card-element');
          hint.textContent = "✅ Stripe initialisé. Entre le client_secret puis clique 'Payer maintenant'.";
        }
        return true;
      }
      ensureStripe();



      // ---------------------------------------------------------
      // Paiement CARTE (confirmation du PaymentIntent existant)
      // Et création commande Shopify PAYÉE via /checkout/confirm
      // ---------------------------------------------------------
      $("#pay-now").onclick = async ()=>{
        if(!ensureStripe()) return;
        const secret = secretInput.value.trim();
        if(!secret){ hint.textContent = "⚠️ Manque client_secret. Clique 'Créer paiement' d’abord."; return; }

        try{
          const { paymentIntent, error } = await stripe.confirmCardPayment(secret, {
            payment_method: { card }
          });
          if(error){
            out.textContent = JSON.stringify({stripe_error:error.message}, null, 2);
            return;
          }
          // Stripe OK -> on crée la commande Shopify "paid"
          const resp = await fetch('/checkout/confirm', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
              stripe_payment_intent_id: paymentIntent.id,
              customer: { email: 'client@example.com' },
              shipping_address: {
                first_name: 'Jean', last_name:'Dubois',
                address1:'123 Rue', city:'Quebec', province:'QC', country:'CA', zip:'G1G1G1'
              },
              items: [
                { title:'Article payé carte', qty:1, price_cents: paymentIntent.amount || 2000 }
              ]
            })
          });
          const created = await resp.json();
          out.textContent = JSON.stringify({ stripe: paymentIntent, shopify: created }, null, 2);
          hint.className = "ok";
          hint.textContent = "✅ Paiement confirmé et commande Shopify créée (payée).";
        }catch(e){
          out.textContent = String(e);
        }
      };

      // ---------------------------------------------------------
      // 2) COD — crée une commande Shopify NON PAYÉE
      // ---------------------------------------------------------
      $("#cod-button").onclick = async ()=>{
        try{
          const res = await fetch('/checkout/cod', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
              customer: { email: 'client@example.com' },
              shipping_address: {
                first_name:'Brandon', last_name:'Lavoie',
                address1:'123 rue du Lac', city:'Dégelis',
                province:'QC', country:'CA', zip:'G5T1R3'
              },
              items: [{ title:'Commande COD - Exemple', qty:1, price_cents: 2000 }],
              total_cents: 2000
            })
          });
          const data = await res.json();
          out.textContent = JSON.stringify({ cod: data }, null, 2);
          hint.className = data.ok ? "ok" : "warn";
          hint.textContent = data.ok ? "✅ Commande COD créée." : "⚠️ Erreur COD — vois la console.";
        }catch(e){
          out.textContent = String(e);
        }
      };
    </script>
  </body>
</html>

