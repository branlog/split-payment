
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Stripe Test - Split Checkout (Card Portion)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <h2>Paiement test (portion carte)</h2>
    <p>Carte test Stripe: <b>4242 4242 4242 4242</b>, date future, CVC 123.</p>
    <div>
      <label>Client Secret (auto depuis URL ?secret=...):</label><br>
      <input id="secret" placeholder="pi_xxx_secret_xxx" style="width:100%;max-width:600px;">
    </div>
    <div style="margin-top:10px;">
      <label>Stripe Publishable Key (auto depuis URL ?pk=...):</label><br>
      <input id="pk" placeholder="pk_test_xxx" style="width:100%;max-width:600px;">
    </div>
    <div id="card-element" style="margin:16px 0;"></div>
    <button id="pay">Payer maintenant</button>
    <pre id="out" style="margin-top:16px;background:#f7f7f7;padding:12px;white-space:pre-wrap;"></pre>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
      function getParam(name){
        const u = new URL(window.location.href);
        return u.searchParams.get(name);
      }
      const secretInput = document.getElementById('secret');
      const pkInput = document.getElementById('pk');
      const out = document.getElementById('out');
      secretInput.value = getParam('secret') || '';
      pkInput.value = getParam('pk') || '';

      let stripe, elements, card;
      function initStripe(){
        const pk = pkInput.value.trim();
        if(!pk){ out.textContent = "‚ö†Ô∏è Entre ta cl√© Stripe publishable (pk_test_...)"; return; }
        stripe = Stripe(pk);
        elements = stripe.elements();
        card = elements.create('card');
        card.mount('#card-element');
        out.textContent = "‚úÖ Stripe initialis√©. Entre le client secret puis clique Payer.";
      }
      initStripe();

      document.getElementById('pay').onclick = async () => {
        try{
          const secret = secretInput.value.trim();
          if(!secret){ out.textContent = "‚ö†Ô∏è Entre un client_secret Stripe."; return; }
          const {paymentIntent, error} = await stripe.confirmCardPayment(secret, {
            payment_method: { card }
          });
          if(error){
            out.textContent = "‚ùå " + error.message;
          } else {
            out.textContent = "‚úÖ Statut: " + paymentIntent.status + "\nPaymentIntent ID: " + paymentIntent.id;
          }
          // Apr√®s le paiement r√©ussi :
if (paymentIntent.status === "succeeded") {
  fetch("https://split-payment-uymv.onrender.com/checkout/confirm", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      payment_intent_id: paymentIntent.id,
      card_amount: 2599, // tu peux dynamiquement mettre le montant carte
      cod_amount: 1899,  // si tu veux tester le split complet
      customer: { email: "client@example.com" },
      shipping_address: {
        first_name: "Jean",
        last_name: "Dubois",
        address1: "123 Rue",
        city: "Quebec",
        country: "CA"
      },
      items: [{ variant_id: 123, qty: 1, pay_method: "card" }]
    })
  })
  .then(r => r.json())
  .then(res => {
    out.textContent += "\n\nüì¶ Commande Shopify : " + JSON.stringify(res, null, 2);
  })
  .catch(err => {
    out.textContent += "\n\n‚ùå Erreur de confirmation : " + err;
  });
}

        }catch(e){
          out.textContent = "‚ùå " + (e.message || e);
        }
      };
    </script>
    <script>
  async function handlePayment() {
    const stripe = Stripe(document.getElementById("pk").value);
    const clientSecret = document.getElementById("secret").value;

    const elements = stripe.elements();
    const cardElement = elements.create("card");
    cardElement.mount("#card-element");

    const result = await stripe.confirmCardPayment(clientSecret, {
      payment_method: {
        card: cardElement,
      },
    });

    const resultDiv = document.getElementById("result");
    if (result.error) {
      resultDiv.innerHTML = "‚ùå Erreur : " + result.error.message;
    } else if (result.paymentIntent.status === "succeeded") {
      resultDiv.innerHTML =
        "<p>‚úÖ Statut : succeeded</p><p>PaymentIntent ID: " +
        result.paymentIntent.id +
        "</p>";

      // ‚¨áÔ∏è Envoie l‚ÄôID au backend pour cr√©er la commande Shopify
      const confirmRes = await fetch("/checkout/confirm", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          stripe_payment_intent_id: result.paymentIntent.id,
          customer: { email: "client@example.com" },
          shipping_address: { address1: "Test", city: "Qu√©bec" },
          items: [],
        }),
      });

      const data = await confirmRes.json();
      resultDiv.innerHTML +=
        "<pre>üì¶ Commande Shopify : " + JSON.stringify(data, null, 2) + "</pre>";
    }
  }
</script>

  </body>
</html>
