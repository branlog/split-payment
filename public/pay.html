<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <title>Paiement test (portion carte)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://js.stripe.com/v3/"></script>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 18px; }
      input { width: 100%; max-width: 640px; padding: 8px; margin: 6px 0 12px; }
      #card-element { padding: 12px; border: 1px solid #ddd; border-radius: 6px; max-width: 640px; }
      button { padding: 10px 14px; border: 0; border-radius: 6px; cursor: pointer; }
      .primary { background: #0a5; color: #fff; }
      .muted { background:#eee; color:#333; }
      pre { background:#f7f7f7; padding:12px; white-space:pre-wrap; max-width: 820px; overflow:auto; }
      .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    </style>
  </head>
  <body>
    <h2>Paiement test (portion carte)</h2>
    <p>Carte test Stripe : <b>4242 4242 4242 4242</b> ‚Ä¢ date future ‚Ä¢ CVC <b>123</b>.</p>

    <label>Client Secret (auto depuis URL <code>?secret=...</code>)</label>
    <input id="secret" placeholder="pi_xxx_secret_xxx" />

    <label>Stripe Publishable Key (auto depuis URL <code>?pk=...</code>)</label>
    <input id="pk" placeholder="pk_test_xxx" />

    <div class="row">
      <button id="prefill" class="muted" type="button">Enregistrer avec link</button>
    </div>

    <div id="card-element" style="margin:12px 0;"></div>

    <div class="row">
      <button id="pay" class="primary" type="button">Payer maintenant</button>
      <span id="status" aria-live="polite"></span>
    </div>

    <h3>R√©sultat</h3>
    <pre id="out">En attente‚Ä¶</pre>

    <script>
      // --- helpers
      const $ = (id) => document.getElementById(id);
      const out = $('out'), statusEl = $('status');
      function log(obj, title) {
        out.textContent = (title ? (title + ' :\n') : '') + JSON.stringify(obj, null, 2);
      }
      function getParam(name){
        const u = new URL(window.location.href);
        return u.searchParams.get(name);
      }

      // --- read URL params
      $('secret').value = getParam('secret') || '';
      $('pk').value = getParam('pk') || '';

      // --- Stripe init (once)
      let stripe, elements, card;
      function initStripe() {
        const pk = $('pk').value.trim();
        if(!pk){ statusEl.textContent = '‚ö†Ô∏è Entrer votre cl√© publishable (pk_test...)'; return; }
        stripe = Stripe(pk);
        elements = stripe.elements();
        card = elements.create('card');
        card.mount('#card-element');
        statusEl.textContent = '‚úÖ Stripe initialis√©. Entrer le client_secret puis cliquer Payer.';
        log({hint: 'Remplissez secret + pk (ou mettez-les dans l‚ÄôURL ?secret=...&pk=...) puis payez.'});
      }
      initStripe();

      // --- bouton "Enregistrer avec link" : met pk+secret dans l‚ÄôURL pour recharger la page
      $('prefill').onclick = () => {
        const url = new URL(window.location.href);
        url.searchParams.set('pk', $('pk').value.trim());
        url.searchParams.set('secret', $('secret').value.trim());
        window.location.href = url.toString();
      };

      // --- bouton "Payer maintenant"
      $('pay').onclick = async () => {
        try {
          const clientSecret = $('secret').value.trim();
          if(!clientSecret){ statusEl.textContent = '‚ö†Ô∏è Entrer un client_secret Stripe.'; return; }
          if(!stripe || !card){ initStripe(); if(!stripe) return; }

          statusEl.textContent = '‚è≥ Confirmation du paiement‚Ä¶';
          const {paymentIntent, error} = await stripe.confirmCardPayment(clientSecret, {
            payment_method: { card }
          });

          if(error){
            statusEl.textContent = '‚ùå Paiement refus√©';
            log({error: error.message}, 'Stripe');
            return;
          }

          log({ status: paymentIntent.status, id: paymentIntent.id }, 'Stripe');
          statusEl.textContent = '‚úÖ Paiement r√©ussi, cr√©ation commande‚Ä¶';

          // --- appelle ton backend pour la confirmation Shopify
          const resp = await fetch('/checkout/confirm', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              stripe_payment_intent_id: paymentIntent.id,
              customer: { email: 'client@example.com' },
              shipping_address: { address1: '123 Rue', city: 'Qu√©bec' },
              items: [] // ici tu peux envoyer tes lignes si besoin
            })
          });

          const data = await resp.json();
          statusEl.textContent = data.ok ? '‚úÖ Commande confirm√©e' : '‚ö†Ô∏è Confirmation avec avertissement';
          out.textContent += '\n\nüì¶ Commande Shopify :\n' + JSON.stringify(data, null, 2);
        } catch (e) {
          statusEl.textContent = '‚ùå Erreur';
          log({ error: e?.message || String(e) }, 'Exception');
        }
      };
  // === Paiement √† la livraison (COD) ===
document.getElementById('cod-button').addEventListener('click', async () => {
  const btn = document.getElementById('cod-button');
  btn.disabled = true;
  btn.textContent = 'Cr√©ation de la commande...';

  try {
    const response = await fetch('/checkout/cod', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        customer: {
          email: 'client@example.com',
        },
        shipping_address: {
          first_name: 'Brandon',
          last_name: 'Lavoie',
          address1: '123 rue du Lac',
          city: 'D√©gelis',
          province: 'QC',
          country: 'CA',
          zip: 'G5T1R3'
        },
        // Tu peux aussi mettre des vrais items Shopify ici si tu veux
        items: [
          {
            title: 'Commande COD - Exemple',
            qty: 1,
            price_cents: 2000
          }
        ],
        total_cents: 2000 // total 20.00$
      })
    });

    const data = await response.json();
    console.log('R√©ponse COD:', data);

    if (data.ok) {
      alert('‚úÖ Commande COD cr√©√©e avec succ√®s sur Shopify !');
      console.log('Commande Shopify:', data.created);
    } else {
      alert('‚ùå Erreur lors de la cr√©ation de la commande COD');
      console.error(data.error);
    }

  } catch (err) {
    console.error('Erreur COD:', err);
    alert('Erreur c√¥t√© serveur.');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Paiement √† la livraison';
  }
});
  </script>
  </body>
</html>
