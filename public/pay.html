
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Stripe Test - Split Checkout (Card Portion)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <h2>Paiement test (portion carte)</h2>
    <p>Carte test Stripe: <b>4242 4242 4242 4242</b>, date future, CVC 123.</p>
    <div>
      <label>Client Secret (auto depuis URL ?secret=...):</label><br>
      <input id="secret" placeholder="pi_xxx_secret_xxx" style="width:100%;max-width:600px;">
    </div>
    <div style="margin-top:10px;">
      <label>Stripe Publishable Key (auto depuis URL ?pk=...):</label><br>
      <input id="pk" placeholder="pk_test_xxx" style="width:100%;max-width:600px;">
    </div>
    <div id="card-element" style="margin:16px 0;"></div>
    <button id="pay">Payer maintenant</button>
    <pre id="out" style="margin-top:16px;background:#f7f7f7;padding:12px;white-space:pre-wrap;"></pre>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
      function getParam(name){
        const u = new URL(window.location.href);
        return u.searchParams.get(name);
      }
      const secretInput = document.getElementById('secret');
      const pkInput = document.getElementById('pk');
      const out = document.getElementById('out');
      secretInput.value = getParam('secret') || '';
      pkInput.value = getParam('pk') || '';

      let stripe, elements, card;
      function initStripe(){
        const pk = pkInput.value.trim();
        if(!pk){ out.textContent = "âš ï¸ Entre ta clÃ© Stripe publishable (pk_test_...)"; return; }
        stripe = Stripe(pk);
        elements = stripe.elements();
        card = elements.create('card');
        card.mount('#card-element');
        out.textContent = "âœ… Stripe initialisÃ©. Entre le client secret puis clique Payer.";
      }
      initStripe();

      document.getElementById('pay').onclick = async () => {
        try{
          const secret = secretInput.value.trim();
          if(!secret){ out.textContent = "âš ï¸ Entre un client_secret Stripe."; return; }
          const {paymentIntent, error} = await stripe.confirmCardPayment(secret, {
            payment_method: { card }
          });
          if(error){
            out.textContent = "âŒ " + error.message;
          } else {
            out.textContent = "âœ… Statut: " + paymentIntent.status + "\nPaymentIntent ID: " + paymentIntent.id;
          }
          // AprÃ¨s le paiement rÃ©ussi :
if (paymentIntent.status === "succeeded") {
  fetch("https://split-payment-uymv.onrender.com/checkout/confirm", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      payment_intent_id: paymentIntent.id,
      card_amount: 2599, // tu peux dynamiquement mettre le montant carte
      cod_amount: 1899,  // si tu veux tester le split complet
      customer: { email: "client@example.com" },
      shipping_address: {
        first_name: "Jean",
        last_name: "Dubois",
        address1: "123 Rue",
        city: "Quebec",
        country: "CA"
      },
      items: [{ variant_id: 123, qty: 1, pay_method: "card" }]
    })
  })
  .then(r => r.json())
  .then(res => {
    out.textContent += "\n\nğŸ“¦ Commande Shopify : " + JSON.stringify(res, null, 2);
  })
  .catch(err => {
    out.textContent += "\n\nâŒ Erreur de confirmation : " + err;
  });
}

        }catch(e){
          out.textContent = "âŒ " + (e.message || e);
        }
      };
    </script>
  </body>
</html>
